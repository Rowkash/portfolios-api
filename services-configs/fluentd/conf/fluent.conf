<source>
  @type tail
  path /var/lib/docker/containers/*/*.log
  pos_file /fluentd/log/docker-containers.pos
  tag docker.**
  <parse>
    @type json
  </parse>
  read_from_head true
</source>

<filter docker.**>
  @type docker_metadata
  docker_url unix:///var/run/docker.sock
#  refresh_interval 60
</filter>

<filter docker.**>
  @type record_transformer
  enable_ruby true
  <record>
    container_name ${record["docker"]["name"]}
    service_name ${record["docker"]["labels"]["com.docker.compose.service"]}
  </record>
</filter>

<filter docker.**>
  @type grep
  <regexp>
#    key service_name
    key container_name
    pattern ^nestjs-sequelize-backend$
  </regexp>
</filter>

<filter docker.**>
  @type record_transformer
  renew_record true
  enable_ruby true
  <record>
    log ${record["log"]}
    service ${record["service_name"]}
    @timestamp ${Time.now.utc.iso8601}
  </record>
</filter>

<filter docker.**>
  @type parser
  key_name log
  reserve_data true
  <parse>
    @type json
  </parse>
</filter>

<match docker.**>
  @type elasticsearch
  host elasticsearch
  user "#{ENV['FLUENTD_USER']}"
  password "#{ENV['FLUENTD_PASSWORD']}"
  port 9200
  index_name nestjs-logs
</match>